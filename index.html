<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://accounts.google.com/gsi/client"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        /* Dark Theme UI Style */
        body { font-family: 'Pretendard', sans-serif; background: #0b1824; color: #ecf0f1; margin: 0; }
        .app { max-width: 1200px; margin: 0 auto; padding: 20px; }
        
        /* Header & Controls */
        header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        .badge { background: #00cec9; color: #000; padding: 2px 8px; border-radius: 10px; font-size: 12px; font-weight: bold; }
        
        .btn { padding: 8px 16px; border-radius: 20px; border: none; cursor: pointer; font-weight: bold; }
        .btn-primary { background: #0984e3; color: white; }
        .btn-outline { background: transparent; border: 1px solid #636e72; color: #dfe6e9; }
        
        .filters { display: flex; gap: 10px; margin-bottom: 15px; }
        .filters input, .filters select { background: #1e272e; border: 1px solid #2f3640; color: white; padding: 8px; border-radius: 5px; flex: 1; }
        
        .stats-bar { display: flex; gap: 15px; margin-bottom: 20px; background: #111822; padding: 15px; border-radius: 10px; font-size: 0.9em; color: #b2bec3; }
        .stats-bar strong { color: #fff; font-size: 1.2em; }

        /* Card List */
        .card { background: #111822; border: 1px solid #1f2933; border-radius: 12px; padding: 16px; margin-bottom: 10px; border-left: 4px solid #0984e3; }
        .card.urgent { border-left-color: #ff7675; }
        
        .card-header { display: flex; justify-content: space-between; font-size: 0.85em; color: #95a5a6; margin-bottom: 5px; }
        .card-title { font-size: 1.1em; font-weight: bold; color: #fff; text-decoration: none; display: block; margin-bottom: 10px; }
        
        .meta-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; font-size: 0.85em; color: #dfe6e9; margin-bottom: 10px; }
        .meta-item span { color: #636e72; display: block; font-size: 0.8em; }

        .ai-box { background: #1e272e; padding: 10px; border-radius: 8px; font-size: 0.9em; color: #a29bfe; margin-bottom: 10px; }
        
        .card-footer { display: flex; justify-content: flex-end; gap: 8px; }
        .btn-sm { padding: 5px 12px; font-size: 0.8em; border-radius: 5px; border: none; cursor: pointer; }
        .btn-cal { background: #e3f2fd; color: #0984e3; }

        /* Modal */
        .modal-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 999; }
        .modal { background: #1e272e; padding: 20px; border-radius: 12px; width: 90%; max-width: 500px; color: white; }
        textarea { width: 100%; height: 150px; background: #111822; border: 1px solid #636e72; color: white; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>

<div class="app">
    <header>
        <h1>í•œêµ­ìˆ˜ì•ˆ AI ì…ì°°ê´€ë¦¬ <span class="badge">v2.0</span></h1>
        <div style="display: flex; gap: 8px;">
            <button class="btn btn-outline" id="btnLogin">ğŸ“… êµ¬ê¸€ ë¡œê·¸ì¸</button>
            <button class="btn btn-primary" onclick="loadData()">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
    </header>

    <div class="stats-bar">
        <div>ì´ ê²€ìƒ‰: <strong id="cnt-total">0</strong>ê±´</div>
        <div>AI ë¶„ì„: <strong id="cnt-ai">0</strong>ê±´</div>
        <div>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: <span id="last-update">-</span></div>
    </div>

    <div class="filters">
        <input id="search" placeholder="ê²€ìƒ‰ì–´ (ì˜ˆ: ì„œìš¸, ì €ë¥˜ì¡°)" oninput="filterList()">
        <select id="filter-region" onchange="filterList()">
            <option value="">ì „ì²´ ì§€ì—­</option>
            <option>ì„œìš¸</option><option>ê²½ê¸°</option><option>ë¶€ì‚°</option><option>ì¸ì²œ</option>
        </select>
        <button class="btn btn-outline" onclick="openSmartModal()">ğŸ“ ìŠ¤ë§ˆíŠ¸ ë“±ë¡</button>
    </div>

    <div id="list"></div>
</div>

<div id="modal-smart" class="modal-backdrop">
    <div class="modal">
        <h3>ğŸ“ ìŠ¤ë§ˆíŠ¸ ê³µê³  ë“±ë¡</h3>
        <p style="font-size:0.9em; color:#ccc">ê³µê³  í…ìŠ¤íŠ¸ë‚˜ ì²¨ë¶€íŒŒì¼ URLì„ ë„£ìœ¼ë©´ AIê°€ ë¶„ì„í•˜ì—¬ ë“±ë¡í•©ë‹ˆë‹¤.</p>
        <textarea id="smart-text" placeholder="ë‚´ìš© ë˜ëŠ” URL ë¶™ì—¬ë„£ê¸°..."></textarea>
        <div style="text-align:right; gap:10px; display:flex; justify-content:flex-end;">
            <button class="btn btn-outline" onclick="closeModal()">ì·¨ì†Œ</button>
            <button class="btn btn-primary" id="btn-smart-save" onclick="runSmartAdd()">âœ¨ ë¶„ì„ ë° ì €ì¥</button>
        </div>
    </div>
</div>

<script>
    // ğŸš¨ [í•„ìˆ˜] ë³¸ì¸ì˜ Apps Script ë°°í¬ URL (exec)
    const API_URL = 'https://script.google.com/macros/s/AKfycbxi0Bfdty9LuMJyxCGTqTkyJQJrevz3AqRunbhNmePCh68tta-Fu8w1Lw4E_DROWB99zw/exec';
    const CLIENT_ID = '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com';
    
    let allData = [];
    let tokenClient;

    // 1. ë°ì´í„° ë¡œë“œ
    async function loadData() {
        document.getElementById('list').innerHTML = '<div style="text-align:center; padding:20px; color:#ccc;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';
        try {
            const res = await fetch(API_URL);
            const json = await res.json();
            allData = json.items || [];
            const stats = json.stats || {};

            document.getElementById('cnt-total').innerText = stats.totalItems || allData.length;
            document.getElementById('cnt-ai').innerText = stats.aiCalls || 0;
            document.getElementById('last-update').innerText = stats.lastUpdate || '-';
            
            renderList(allData);
        } catch(e) {
            document.getElementById('list').innerHTML = `<div style="text-align:center; color:red;">ë¡œë“œ ì‹¤íŒ¨: ${e.message}</div>`;
        }
    }

    // 2. ë¦¬ìŠ¤íŠ¸ ë Œë”ë§
    function renderList(data) {
        const list = document.getElementById('list');
        list.innerHTML = "";
        if(data.length === 0) { list.innerHTML = '<div style="text-align:center; padding:40px; color:#666;">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</div>'; return; }

        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card normal';
            div.innerHTML = `
                <div class="card-header">
                    <span>${item.no} | ${item.region}</span>
                    <span style="color:#ff7675">${item.status}</span>
                </div>
                <a href="${item.link}" target="_blank" class="card-title">${item.title}</a>
                <div class="meta-grid">
                    <div class="meta-item"><span>ë°œì£¼ì²˜</span>${item.client}</div>
                    <div class="meta-item"><span>ê¸ˆì•¡</span>${item.serviceAmount}</div>
                    <div class="meta-item"><span>ë§ˆê°</span>${item.deadline.split(' ')[0]}</div>
                </div>
                <div class="ai-box">ğŸ¤– ${item.aiResult}</div>
                <div class="card-footer">
                    <button class="btn-sm btn-cal" onclick="registerCalendar('${item.rowIndex}')">ğŸ“… ì¼ì • ë“±ë¡</button>
                    ${item.status === 'ìˆ˜ë™ë“±ë¡' ? `<button class="btn-sm" style="background:#fab1a0" onclick="deleteItem('${item.rowIndex}')">ì‚­ì œ</button>` : ''}
                </div>
            `;
            list.appendChild(div);
        });
    }

    // 3. í•„í„°
    function filterList() {
        const q = document.getElementById('search').value.toLowerCase();
        const reg = document.getElementById('filter-region').value;
        const filtered = allData.filter(d => 
            (d.title.toLowerCase().includes(q) || d.client.includes(q)) &&
            (reg === "" || d.region.includes(reg))
        );
        renderList(filtered);
    }

    // 4. ìŠ¤ë§ˆíŠ¸ ë“±ë¡
    async function runSmartAdd() {
        const txt = document.getElementById('smart-text').value;
        if(!txt) return;
        const btn = document.getElementById('btn-smart-save');
        btn.innerText = "â³ ë¶„ì„ ì¤‘..."; btn.disabled = true;
        
        // URLì¸ì§€ í…ìŠ¤íŠ¸ì¸ì§€ êµ¬ë¶„í•˜ì—¬ ì „ì†¡
        const isUrl = txt.startsWith("http");
        const params = new URLSearchParams({ 
            action: 'smart_add', 
            fileUrl: isUrl ? txt : '', 
            text: isUrl ? '' : txt 
        });

        try {
            await fetch(`${API_URL}?${params.toString()}`, { mode: 'no-cors' });
            alert("âœ… ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (ì ì‹œ í›„ ëª©ë¡ì— ë°˜ì˜ë©ë‹ˆë‹¤)");
            closeModal();
            setTimeout(loadData, 2000);
        } catch(e) { alert("ì‹¤íŒ¨: " + e.message); }
        finally { btn.innerText = "âœ¨ ë¶„ì„ ë° ì €ì¥"; btn.disabled = false; }
    }

    // 5. ìº˜ë¦°ë” ë“±ë¡ (ì„œë²„ ìœ„ì„)
    async function registerCalendar(rowIndex) {
        if(!confirm("ì´ ê³µê³ ë¥¼ ìº˜ë¦°ë”ì— ë“±ë¡í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        try {
            // ì„œë²„ë¡œ ìš”ì²­ (CalendarApp ì‚¬ìš©)
            await fetch(`${API_URL}?action=calendar_add&rowIndex=${rowIndex}`, {mode: 'no-cors'});
            alert("âœ… ìº˜ë¦°ë”ì— ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨: " + e.message); }
    }

    function deleteItem(rowIndex) {
        if(!confirm("ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
        fetch(`${API_URL}?action=deleteRow&rowIndex=${rowIndex}`, {mode:'no-cors'})
            .then(() => { alert("ì‚­ì œë¨"); loadData(); });
    }

    // UI ì œì–´
    function openSmartModal() { document.getElementById('modal-smart').style.display = 'flex'; }
    function closeModal() { document.getElementById('modal-smart').style.display = 'none'; }

    // êµ¬ê¸€ ë¡œê·¸ì¸ (UIìš©)
    function initGoogle() {
        google.accounts.oauth2.initTokenClient({
            client_id: '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com',
            scope: 'https://www.googleapis.com/auth/calendar.events',
            callback: (resp) => {
                if(resp.access_token) {
                    document.getElementById('btnLogin').innerText = "âœ… ë¡œê·¸ì¸ë¨";
                    document.getElementById('btnLogin').disabled = true;
                }
            }
        });
        document.getElementById('btnLogin').onclick = () => {
            google.accounts.oauth2.initTokenClient({
                client_id: '1049915608396-i3jn8jrm24bc9mkagdtokk3rfa3li513.apps.googleusercontent.com',
                scope: 'https://www.googleapis.com/auth/calendar.events',
                callback: (r) => { if(r.access_token) document.getElementById('btnLogin').innerText = "âœ… ë¡œê·¸ì¸ë¨"; }
            }).requestAccessToken();
        };
    }

    loadData();
    window.onload = initGoogle;
</script>
</body>
</html>
